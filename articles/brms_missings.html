<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handle Missing Values with brms • brms</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Handle Missing Values with brms">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.9.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/projpred">projpred</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools">rstantools</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/brms">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Handle Missing Values with brms</h1>
                        <h4 class="author">Paul Bürkner</h4>
            
            <h4 class="date">2019-05-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/paul-buerkner/brms/blob/master/vignettes/brms_missings.Rmd"><code>vignettes/brms_missings.Rmd</code></a></small>
      <div class="hidden name"><code>brms_missings.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Many real world data sets contain missing values for various reasons. Generally, we have quite a few options to handle those missing values. The easiest solution is to remove all rows from the data set, where one or more variables are missing. However, if values are not missing completely at random, this will likely lead to bias in our analysis. Accordingly, we usually want to impute missing values in one way or the other. Here, we will consider two very general approaches using <strong>brms</strong>: (1) Impute missing values <em>before</em> the model fitting with multiple imputation, and (2) impute missing values on the fly <em>during</em> model fitting<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. As a simple example, we will use the <code>nhanes</code> data set, which contains information on participants’ <code>age</code>, <code>bmi</code> (body mass index), <code>hyp</code> (hypertensive), and <code>chl</code> (total serum cholesterol). For the purpose of the present vignette, we are primarily interested in predicting <code>bmi</code> by <code>age</code> and <code>chl</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"nhanes"</span>, <span class="dt">package =</span> <span class="st">"mice"</span>)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(nhanes)</a></code></pre></div>
<pre><code>  age  bmi hyp chl
1   1   NA  NA  NA
2   2 22.7   1 187
3   1   NA   1 187
4   3   NA  NA  NA
5   1 20.4   1 113
6   3   NA  NA 184</code></pre>
</div>
<div id="imputation-before-model-fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#imputation-before-model-fitting" class="anchor"></a>Imputation before model fitting</h2>
<p>There are many approaches allowing us to impute missing data before the actual model fitting takes place. From a statistical perspective, multiple imputation is one of the best solutions. Each missing value is not imputed once but  times leading to a total of  fully imputed data sets. The model can then be fitted to each of those data sets separetely and results are pooled across models, afterwards. One widely applied package for multiple imputation is <strong>mice</strong> (Buuren &amp; Groothuis-Oudshoorn, 2010) and we will use it in the following in combination with <strong>brms</strong>. Here, we apply the default settings of <strong>mice</strong>, which means that all variables will be used to impute missing values in all other variables and imputation functions automatically chosen based on the variables’ characteristics.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(mice)</a>
<a class="sourceLine" id="cb3-2" title="2">imp &lt;-<span class="st"> </span><span class="kw">mice</span>(nhanes, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">print =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>Now, we have <code>m = 5</code> imputed data sets stored within the <code>imp</code> object. We could either extract those data sets and then pass them to the actual model fitting function as a list of data frames, or pass <code>imp</code> directly. The latter works because <strong>brms</strong> offers special support for data imputed by <strong>mice</strong>. We will go with the latter approach, since it is less typing. Fitting our model of interest with <strong>brms</strong> to the multiple imputed data sets is straightforward.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">fit_imp1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/brm_multiple.html">brm_multiple</a></span>(bmi <span class="op">~</span><span class="st"> </span>age<span class="op">*</span>chl, <span class="dt">data =</span> imp, <span class="dt">chains =</span> <span class="dv">2</span>)</a></code></pre></div>
<p>The returned fitted model is an ordinary <code>brmsfit</code> object containing the posterior samples of all <code>m</code> submodels. While pooling across models is not necessarily straightforward in classical statistics, it is trivial in a Bayesian framework. Here, pooling results of multiple imputed data sets is simply achieved by combining the posterior samples of the submodels. Accordingly, all post-processing methods can be used out of the box without having to worry about pooling at all.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(fit_imp1)</a></code></pre></div>
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: bmi ~ age * chl 
   Data: imp (Number of observations: 25) 
Samples: 10 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup samples = 10000

Population-Level Effects: 
          Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
Intercept    16.30      8.54    -1.51    32.88         25 1.14
age           0.23      5.31   -10.08    10.85         18 1.19
chl           0.08      0.05    -0.01     0.18         19 1.19
age:chl      -0.02      0.03    -0.07     0.03         19 1.19

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
sigma     3.33      0.65     2.30     4.81         19 1.18

Samples were drawn using sampling(NUTS). For each parameter, Eff.Sample 
is a crude measure of effective sample size, and Rhat is the potential 
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>In the summary output, we notice that some <code>Rhat</code> values are higher than <span class="math inline">\(1.1\)</span> indicating possible convergence problems. For models based on multiple imputed data sets, this is often a <strong>false positive</strong>: Chains of different submodels may not overlay each other exactly, since there were fitted to different data. We can see the chains on the right-hand side of</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(fit_imp1, <span class="dt">pars =</span> <span class="st">"^b"</span>)</a></code></pre></div>
<p><img src="brms_missings_files/figure-html/unnamed-chunk-5-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Such non-overlaying chains imply high <code>Rhat</code> values without there actually being any convergence issue. Accordingly, we have to investigate the convergence of the submodels separately, which we can do by looking at</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(fit_imp1<span class="op">$</span>rhats, <span class="dv">2</span>)</a></code></pre></div>
<pre><code>  b_Intercept b_age b_chl b_age.chl sigma lp__
1           1     1     1         1  1.01 1.01
2           1     1     1         1  1.00 1.00
3           1     1     1         1  1.00 1.00
4           1     1     1         1  1.00 1.01
5           1     1     1         1  1.00 1.01</code></pre>
<p>The convergence of each of the submodels looks good. Accordingly, we can proceed with further post-processing and interpreation of the results. For instance, we could investigate the combined effect of <code>age</code> and <code>chl</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw"><a href="../reference/marginal_effects.html">marginal_effects</a></span>(fit_imp1, <span class="st">"age:chl"</span>)</a></code></pre></div>
<p><img src="brms_missings_files/figure-html/unnamed-chunk-7-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>To summarize, the advantages of multiple imputation are obvious: One can apply it to all kinds of models, since model fitting functions do not need to know that the data sets were imputed, beforehand. Also, we do not need to worry about pooling across submodels when using fully Bayesian methods. The only drawback is the amount of time required for model fitting. Estimating Bayesian models is already quite slow with just a single data set and it only gets worse when working with multiple imputation.</p>
<div id="compatibility-with-other-multiple-imputation-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#compatibility-with-other-multiple-imputation-packages" class="anchor"></a>Compatibility with other multiple imputation packages</h3>
<p><strong>brms</strong> offers built-in support for <strong>mice</strong> mainly because I use the latter in some of my own research projects. Nevertheless, <code>brm_multiple</code> supports all kinds of multiple imputation packages as it also accepts a <em>list</em> of data frames as input for its <code>data</code> argument. Thus, you just need to extract the imputed data frames in the form of a list, which can then be passed to <code>brm_multiple</code>. Most multiple imputation packages have some built-in functionality for this task. When using the <strong>mi</strong> package, for instance, you simply need to call the <code>mi::complete</code> function to get the desired output.</p>
</div>
</div>
<div id="imputation-during-model-fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#imputation-during-model-fitting" class="anchor"></a>Imputation during model fitting</h2>
<p>Imputation during model fitting is generally thought to be more complex than imputation before model fitting, because one has to take care of everything within one step. This remains true when imputing missing values with <strong>brms</strong>, but possibly to a somewhat smaller degree. Consider again the <code>nhanes</code> data with the goal to predict <code>bmi</code> by <code>age</code>, and <code>chl</code>. Since <code>age</code> contains no missing values, we only have to take special care of <code>bmi</code> and <code>chl</code>. We need to tell the model two things. (1) Which variables contain missing values and how they should be predicted, as well as (2) which of these imputed variables should be used as predictors. In <strong>brms</strong> we can do this as follows:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">bform &lt;-<span class="st"> </span><span class="kw"><a href="../reference/brmsformula.html">bf</a></span>(bmi <span class="op">|</span><span class="st"> </span><span class="kw"><a href="../reference/mi.html">mi</a></span>() <span class="op">~</span><span class="st"> </span>age <span class="op">*</span><span class="st"> </span><span class="kw"><a href="../reference/mi.html">mi</a></span>(chl)) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="st">  </span><span class="kw"><a href="../reference/brmsformula.html">bf</a></span>(chl <span class="op">|</span><span class="st"> </span><span class="kw"><a href="../reference/mi.html">mi</a></span>() <span class="op">~</span><span class="st"> </span>age) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/brmsformula-helpers.html">set_rescor</a></span>(<span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb11-3" title="3">fit_imp2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/brm.html">brm</a></span>(bform, <span class="dt">data =</span> nhanes)</a></code></pre></div>
<p>The model has become multivariate, as we no longer only predict <code>bmi</code> but also <code>chl</code> (see <code><a href="../articles/brms_multivariate.html">vignette("brms_multivariate")</a></code> for details about the multivariate syntax of <strong>brms</strong>). We ensure that missings in both variables will be modeled rather than excluded by adding <code>| mi()</code> on the left-hand side of the formulas<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. We write <code><a href="../reference/mi.html">mi(chl)</a></code> on the right-hand side of the formula for <code>bmi</code> to ensure that the estimated missing values of <code>chl</code> will be used in the prediction of <code>bmi</code>. The summary is a bit more cluttered as we get coefficients for both response variables, but apart from that we can interprete coefficients in the usual way.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(fit_imp2)</a></code></pre></div>
<pre><code> Family: MV(gaussian, gaussian) 
  Links: mu = identity; sigma = identity
         mu = identity; sigma = identity 
Formula: bmi | mi() ~ age * mi(chl) 
         chl | mi() ~ age 
   Data: nhanes (Number of observations: 25) 
Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup samples = 4000

Population-Level Effects: 
              Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
bmi_Intercept    13.68      8.80    -3.18    32.35       1659 1.00
chl_Intercept   141.44     24.62    93.66   192.23       2485 1.00
bmi_age           1.24      5.53    -9.63    11.99       1467 1.00
chl_age          29.10     13.10     3.01    55.34       2339 1.00
bmi_michl         0.10      0.05     0.01     0.19       1714 1.00
bmi_michl:age    -0.03      0.02    -0.07     0.03       1494 1.00

Family Specific Parameters: 
          Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
sigma_bmi     3.33      0.79     2.18     5.22       1426 1.00
sigma_chl    40.11      7.76    28.29    58.32       1899 1.00

Samples were drawn using sampling(NUTS). For each parameter, Eff.Sample 
is a crude measure of effective sample size, and Rhat is the potential 
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw"><a href="../reference/marginal_effects.html">marginal_effects</a></span>(fit_imp2, <span class="st">"age:chl"</span>, <span class="dt">resp =</span> <span class="st">"bmi"</span>)</a></code></pre></div>
<p><img src="brms_missings_files/figure-html/unnamed-chunk-9-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The results look pretty similar to those obtained from multiple imputation, but be aware that this may not be generally the case. In multiple imputation, the default is to impute all variables based on all other variables, while in the ‘one-step’ approach, we have to explictly specify the variables used in the imputation. Thus, arguably, multiple imputation is easier to apply. An obvious advantage of the ‘one-step’ approach is that the model needs to be fitted only once instead of <code>m</code> times. Also, within the <strong>brms</strong> framework, we can use multilevel structure and complex non-linear relationships for the imputation of missing values, which is not achieved as easily in standard multiple imputation software. On the downside, it is currently not possible to impute discrete variables, because <strong>Stan</strong> (the engine behind <strong>brms</strong>) does not allow estimating discrete parameters.</p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Buuren, S. V., &amp; Groothuis-Oudshoorn, K. (2010). mice: Multivariate imputation by chained equations in R. <em>Journal of Statistical Software</em>, 1-68.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Actually, there is a third approach that only applies to missings in response variables. If we want to impute missing responses, we just fit the model using the observed responses and than impute the missings <em>after</em> fitting the model by means of posterior prediction. That is, we supply the predictor values corresponding to missing responses to the <code>predict</code> method.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>We don’t really need this for <code>bmi</code>, since <code>bmi</code> is not used as a predictor for another variable. Accordingly, we could also – and equivalently – impute missing values of <code>bmi</code> <em>after</em> model fitting by means of posterior prediction.<a href="#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#imputation-before-model-fitting">Imputation before model fitting</a></li>
      <li><a href="#imputation-during-model-fitting">Imputation during model fitting</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Paul-Christian Bürkner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
