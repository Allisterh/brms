<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Stan Code for <span class="pkg">brms</span> Models — make_stancode • brms</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Stan Code for <span class="pkg">brms</span> Models — make_stancode" />

<meta property="og:description" content="Generate Stan code for brms models" />
<meta name="twitter:card" content="summary" />


<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brms</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">2.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/brms_customfamilies.html">Define Custom Response Distributions with brms</a>
    </li>
    <li>
      <a href="../articles/brms_distreg.html">Estimating Distributional Models with brms</a>
    </li>
    <li>
      <a href="../articles/brms_families.html">Parameterization of Response Distributions in brms</a>
    </li>
    <li>
      <a href="../articles/brms_missings.html">Handle Missing Values with brms</a>
    </li>
    <li>
      <a href="../articles/brms_monotonic.html">Estimating Monotonic Effects with brms</a>
    </li>
    <li>
      <a href="../articles/brms_multivariate.html">Estimating Multivariate Models with brms</a>
    </li>
    <li>
      <a href="../articles/brms_nonlinear.html">Estimating Non-Linear Models with brms</a>
    </li>
    <li>
      <a href="../articles/brms_phylogenetics.html">Estimating Phylogenetic Multilevel Models with brms</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/paul-buerkner/brms">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Stan Code for <span class="pkg">brms</span> Models</h1>
    <small class="dont-index">Source: <a href='https://github.com/paul-buerkner/brms/blob/master/R/make_stancode.R'><code>R/make_stancode.R</code></a></small>
    <div class="hidden name"><code>make_stancode.Rd</code></div>
    </div>

    <div class="ref-description">
    
    <p>Generate Stan code for <span class="pkg">brms</span> models</p>
    
    </div>

    <pre class="usage"><span class='fu'>make_stancode</span>(<span class='no'>formula</span>, <span class='no'>data</span>, <span class='kw'>family</span> <span class='kw'>=</span> <span class='fu'>gaussian</span>(), <span class='kw'>prior</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>autocor</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>cov_ranef</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>sparse</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>sample_prior</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='st'>"no"</span>, <span class='st'>"yes"</span>, <span class='st'>"only"</span>), <span class='kw'>stanvars</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>stan_funs</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>save_model</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>silent</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='no'>...</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>formula</th>
      <td><p>An object of class 
<code><a href='http://www.rdocumentation.org/packages/stats/topics/formula'>formula</a></code>,
<code><a href='brmsformula.html'>brmsformula</a></code>, or <code><a href='mvbrmsformula.html'>mvbrmsformula</a></code>
(or one that can be coerced to that classes): 
A symbolic description of the model to be fitted. 
The details of model specification are explained in 
<code><a href='brmsformula.html'>brmsformula</a></code>.</p></td>
    </tr>
    <tr>
      <th>data</th>
      <td><p>An object of class <code>data.frame</code> 
(or one that can be coerced to that class) 
containing data of all variables used in the model.</p></td>
    </tr>
    <tr>
      <th>family</th>
      <td><p>A description of the response distribution and link function 
to be used in the model. This can be a family function, 
a call to a family function or a character string naming the family.
Every family function has a <code>link</code> argument allowing to specify
the link function to be applied on the response variable.
If not specified, default links are used.
For details of supported families see 
<code><a href='brmsfamily.html'>brmsfamily</a></code>.
By default, a linear <code>gaussian</code> model is applied.
In multivariate models, <code>family</code> might also be a list of families.</p></td>
    </tr>
    <tr>
      <th>prior</th>
      <td><p>One or more <code>brmsprior</code> objects created by
<code><a href='set_prior.html'>set_prior</a></code> or related functions 
and combined using the <code>c</code> method or the <code>+</code> operator.
See also  <code><a href='get_prior.html'>get_prior</a></code> for more help.</p></td>
    </tr>
    <tr>
      <th>autocor</th>
      <td><p>An optional <code><a href='cor_brms.html'>cor_brms</a></code> object describing 
the correlation structure within the response variable 
(i.e., the 'autocorrelation'). 
See the documentation of <code><a href='cor_brms.html'>cor_brms</a></code> for a description 
of the available correlation structures. Defaults to <code>NULL</code>, 
corresponding to no correlations.
In multivariate models, <code>autocor</code> might also be a list 
of autocorrelation structures.</p></td>
    </tr>
    <tr>
      <th>cov_ranef</th>
      <td><p>A list of matrices that are proportional to the 
(within) covariance structure of the group-level effects. 
The names of the matrices should correspond to columns 
in <code>data</code> that are used as grouping factors. 
All levels of the grouping factor should appear as rownames 
of the corresponding matrix. This argument can be used,
among others to model pedigrees and phylogenetic effects.
See <code><a href='../articles/brms_phylogenetics.html'>vignette("brms_phylogenetics")</a></code> for more details.</p></td>
    </tr>
    <tr>
      <th>sparse</th>
      <td><p>Logical; indicates whether the population-level 
design matrices should be treated as sparse (defaults to <code>FALSE</code>). 
For design matrices with many zeros, this can considerably 
reduce required memory. Sampling speed is currently not 
improved or even slightly decreased.</p></td>
    </tr>
    <tr>
      <th>sample_prior</th>
      <td><p>Indicate if samples from all specified 
proper priors should be drawn additionally to the posterior samples
(defaults to <code>"no"</code>). Among others, these samples can be used 
to calculate Bayes factors for point hypotheses. 
If set to <code>"only"</code>, samples are drawn solely from
the priors ignoring the likelihood. In this case, 
all parameters must have proper priors.</p></td>
    </tr>
    <tr>
      <th>stanvars</th>
      <td><p>An optional <code>stanvars</code> object generated
by function <code><a href='stanvar.html'>stanvar</a></code> to define additional variables
in the data block of <span class="pkg">Stan</span>.</p></td>
    </tr>
    <tr>
      <th>stan_funs</th>
      <td><p>An optional character string containing self-defined 
<span class="pkg">Stan</span> functions, which will be included in the functions block 
of the generated <span class="pkg">Stan</span> code.</p></td>
    </tr>
    <tr>
      <th>save_model</th>
      <td><p>Either <code>NULL</code> or a character string. 
In the latter case, the model code is
saved in a file named after the string supplied in <code>save_model</code>, 
which may also contain the full path where to save the file.
If only a name is given, the file is saved in the current working directory.</p></td>
    </tr>
    <tr>
      <th>silent</th>
      <td><p>logical; If <code>TRUE</code>, warnings of
the Stan parser will be suppressed.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Other arguments for internal usage only</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A character string containing the fully commented <span class="pkg">Stan</span> code 
  to fit a <span class="pkg">brms</span> model.</p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='fu'>make_stancode</span>(<span class='no'>rating</span> ~ <span class='no'>treat</span> + <span class='no'>period</span> + <span class='no'>carry</span> + (<span class='fl'>1</span><span class='kw'>|</span><span class='no'>subject</span>),
              <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>inhaler</span>, <span class='kw'>family</span> <span class='kw'>=</span> <span class='st'>"cumulative"</span>)</div><div class='output co'>#&gt; // generated with brms 2.3.1
#&gt; functions { 
#&gt;   /* cumulative-logit log-PDF for a single response
#&gt;    * Args:
#&gt;    *   y: response category
#&gt;    *   mu: linear predictor
#&gt;    *   thres: ordinal thresholds
#&gt;    *   disc: discrimination parameter
#&gt;    * Returns:
#&gt;    *   a scalar to be added to the log posterior
#&gt;    */
#&gt;    real cumulative_logit_lpmf(int y, real mu, vector thres, real disc) {
#&gt;      int ncat = num_elements(thres) + 1;
#&gt;      real p;
#&gt;      if (y == 1) {
#&gt;        p = inv_logit(disc * (thres[1] - mu));
#&gt;      } else if (y == ncat) {
#&gt;        p = 1 - inv_logit(disc * (thres[ncat - 1] - mu));
#&gt;      } else {
#&gt;        p = inv_logit(disc * (thres[y] - mu)) -
#&gt;            inv_logit(disc * (thres[y - 1] - mu));
#&gt;      }
#&gt;      return log(p);
#&gt;    } 
#&gt;   /* cumulative-logit log-PDF for a single response
#&gt;    * including category specific effects
#&gt;    * Args:
#&gt;    *   y: response category
#&gt;    *   mu: linear predictor
#&gt;    *   mucs: predictor for category specific effects
#&gt;    *   thres: ordinal thresholds
#&gt;    *   disc: discrimination parameter
#&gt;    * Returns:
#&gt;    *   a scalar to be added to the log posterior
#&gt;    */
#&gt;    real cumulative_logit_cs_lpmf(int y, real mu, row_vector mucs, vector thres, real disc) {
#&gt;      int ncat = num_elements(thres) + 1;
#&gt;      real p;
#&gt;      if (y == 1) {
#&gt;        p = inv_logit(disc * (thres[1] - mucs[1] - mu));
#&gt;      } else if (y == ncat) {
#&gt;        p = 1 - inv_logit(disc * (thres[ncat - 1] - mucs[ncat - 1] - mu));
#&gt;      } else {
#&gt;        p = inv_logit(disc * (thres[y] - mucs[y] - mu)) -
#&gt;            inv_logit(disc * (thres[y - 1] - mucs[y - 1] - mu));
#&gt;      }
#&gt;      return log(p);
#&gt;    } 
#&gt; } 
#&gt; data { 
#&gt;   int&lt;lower=1&gt; N;  // total number of observations 
#&gt;   int Y[N];  // response variable 
#&gt;   int&lt;lower=2&gt; ncat;  // number of categories 
#&gt;   int&lt;lower=1&gt; K;  // number of population-level effects 
#&gt;   matrix[N, K] X;  // population-level design matrix 
#&gt;   real&lt;lower=0&gt; disc;  // discrimination parameters 
#&gt;   // data for group-level effects of ID 1
#&gt;   int&lt;lower=1&gt; J_1[N];
#&gt;   int&lt;lower=1&gt; N_1;
#&gt;   int&lt;lower=1&gt; M_1;
#&gt;   vector[N] Z_1_1;
#&gt;   int prior_only;  // should the likelihood be ignored? 
#&gt; } 
#&gt; transformed data { 
#&gt;   int Kc = K - 1; 
#&gt;   matrix[N, K - 1] Xc;  // centered version of X 
#&gt;   vector[K - 1] means_X;  // column means of X before centering 
#&gt;   for (i in 2:K) { 
#&gt;     means_X[i - 1] = mean(X[, i]); 
#&gt;     Xc[, i - 1] = X[, i] - means_X[i - 1]; 
#&gt;   } 
#&gt; } 
#&gt; parameters { 
#&gt;   vector[Kc] b;  // population-level effects 
#&gt;   ordered[ncat-1] temp_Intercept;  // temporary thresholds 
#&gt;   vector&lt;lower=0&gt;[M_1] sd_1;  // group-level standard deviations
#&gt;   vector[N_1] z_1[M_1];  // unscaled group-level effects
#&gt; } 
#&gt; transformed parameters { 
#&gt;   // group-level effects 
#&gt;   vector[N_1] r_1_1 = sd_1[1] * (z_1[1]);
#&gt; } 
#&gt; model { 
#&gt;   vector[N] mu = Xc * b; 
#&gt;   for (n in 1:N) { 
#&gt;     mu[n] += r_1_1[J_1[n]] * Z_1_1[n];
#&gt;   } 
#&gt;   // priors including all constants 
#&gt;   target += student_t_lpdf(temp_Intercept | 3, 0, 10); 
#&gt;   target += student_t_lpdf(sd_1 | 3, 0, 10)
#&gt;     - 1 * student_t_lccdf(0 | 3, 0, 10); 
#&gt;   target += normal_lpdf(z_1[1] | 0, 1);
#&gt;   // likelihood including all constants 
#&gt;   if (!prior_only) { 
#&gt;     for (n in 1:N) { 
#&gt;       target += ordered_logistic_lpmf(Y[n] | mu[n], temp_Intercept); 
#&gt;     } 
#&gt;   } 
#&gt; } 
#&gt; generated quantities { 
#&gt;   // compute actual thresholds 
#&gt;   vector[ncat - 1] b_Intercept = temp_Intercept + dot_product(means_X, b); 
#&gt; } </div><div class='input'>
<span class='fu'>make_stancode</span>(<span class='no'>count</span> ~ <span class='no'>log_Age_c</span> + <span class='no'>log_Base4_c</span> * <span class='no'>Trt_c</span>
              + (<span class='fl'>1</span><span class='kw'>|</span><span class='no'>patient</span>) + (<span class='fl'>1</span><span class='kw'>|</span><span class='no'>visit</span>),
              <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>epilepsy</span>, <span class='kw'>family</span> <span class='kw'>=</span> <span class='st'>"poisson"</span>)</div><div class='output co'>#&gt; // generated with brms 2.3.1
#&gt; functions { 
#&gt; } 
#&gt; data { 
#&gt;   int&lt;lower=1&gt; N;  // total number of observations 
#&gt;   int Y[N];  // response variable 
#&gt;   int&lt;lower=1&gt; K;  // number of population-level effects 
#&gt;   matrix[N, K] X;  // population-level design matrix 
#&gt;   // data for group-level effects of ID 1
#&gt;   int&lt;lower=1&gt; J_1[N];
#&gt;   int&lt;lower=1&gt; N_1;
#&gt;   int&lt;lower=1&gt; M_1;
#&gt;   vector[N] Z_1_1;
#&gt;   // data for group-level effects of ID 2
#&gt;   int&lt;lower=1&gt; J_2[N];
#&gt;   int&lt;lower=1&gt; N_2;
#&gt;   int&lt;lower=1&gt; M_2;
#&gt;   vector[N] Z_2_1;
#&gt;   int prior_only;  // should the likelihood be ignored? 
#&gt; } 
#&gt; transformed data { 
#&gt;   int Kc = K - 1; 
#&gt;   matrix[N, K - 1] Xc;  // centered version of X 
#&gt;   vector[K - 1] means_X;  // column means of X before centering 
#&gt;   for (i in 2:K) { 
#&gt;     means_X[i - 1] = mean(X[, i]); 
#&gt;     Xc[, i - 1] = X[, i] - means_X[i - 1]; 
#&gt;   } 
#&gt; } 
#&gt; parameters { 
#&gt;   vector[Kc] b;  // population-level effects 
#&gt;   real temp_Intercept;  // temporary intercept 
#&gt;   vector&lt;lower=0&gt;[M_1] sd_1;  // group-level standard deviations
#&gt;   vector[N_1] z_1[M_1];  // unscaled group-level effects
#&gt;   vector&lt;lower=0&gt;[M_2] sd_2;  // group-level standard deviations
#&gt;   vector[N_2] z_2[M_2];  // unscaled group-level effects
#&gt; } 
#&gt; transformed parameters { 
#&gt;   // group-level effects 
#&gt;   vector[N_1] r_1_1 = sd_1[1] * (z_1[1]);
#&gt;   // group-level effects 
#&gt;   vector[N_2] r_2_1 = sd_2[1] * (z_2[1]);
#&gt; } 
#&gt; model { 
#&gt;   vector[N] mu = Xc * b + temp_Intercept; 
#&gt;   for (n in 1:N) { 
#&gt;     mu[n] += r_1_1[J_1[n]] * Z_1_1[n] + r_2_1[J_2[n]] * Z_2_1[n];
#&gt;   } 
#&gt;   // priors including all constants 
#&gt;   target += student_t_lpdf(temp_Intercept | 3, 1, 10); 
#&gt;   target += student_t_lpdf(sd_1 | 3, 0, 10)
#&gt;     - 1 * student_t_lccdf(0 | 3, 0, 10); 
#&gt;   target += normal_lpdf(z_1[1] | 0, 1);
#&gt;   target += student_t_lpdf(sd_2 | 3, 0, 10)
#&gt;     - 1 * student_t_lccdf(0 | 3, 0, 10); 
#&gt;   target += normal_lpdf(z_2[1] | 0, 1);
#&gt;   // likelihood including all constants 
#&gt;   if (!prior_only) { 
#&gt;     target += poisson_log_lpmf(Y | mu); 
#&gt;   } 
#&gt; } 
#&gt; generated quantities { 
#&gt;   // actual population-level intercept 
#&gt;   real b_Intercept = temp_Intercept - dot_product(means_X, b); 
#&gt; } </div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by Paul-Christian Bürkner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  

  </body>
</html>

